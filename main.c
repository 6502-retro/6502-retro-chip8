/* vim: set et ts=4 sw=4: */
#include <6502.h>
#include <string.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdio.h>
#include "sfos.h"
#include "bios.h"
#include "vdp.h"
#include "chip8.h"

Chip8 *chip;
uint16_t i = 0;
uint16_t j = 0;
uint8_t argc = 0;
char *argv[8] = {0};
char *cmd = (char*)0x301;

uint8_t logo[] = {
  0x00, 0xe0, 0xa2, 0x2a, 0x60, 0x0c, 0x61, 0x08, 0xd0, 0x1f, 0x70, 0x09,
  0xa2, 0x39, 0xd0, 0x1f, 0xa2, 0x48, 0x70, 0x08, 0xd0, 0x1f, 0x70, 0x04,
  0xa2, 0x57, 0xd0, 0x1f, 0x70, 0x08, 0xa2, 0x66, 0xd0, 0x1f, 0x70, 0x08,
  0xa2, 0x75, 0xd0, 0x1f, 0x12, 0x28, 0xff, 0x00, 0xff, 0x00, 0x3c, 0x00,
  0x3c, 0x00, 0x3c, 0x00, 0x3c, 0x00, 0xff, 0x00, 0xff, 0xff, 0x00, 0xff,
  0x00, 0x38, 0x00, 0x3f, 0x00, 0x3f, 0x00, 0x38, 0x00, 0xff, 0x00, 0xff,
  0x80, 0x00, 0xe0, 0x00, 0xe0, 0x00, 0x80, 0x00, 0x80, 0x00, 0xe0, 0x00,
  0xe0, 0x00, 0x80, 0xf8, 0x00, 0xfc, 0x00, 0x3e, 0x00, 0x3f, 0x00, 0x3b,
  0x00, 0x39, 0x00, 0xf8, 0x00, 0xf8, 0x03, 0x00, 0x07, 0x00, 0x0f, 0x00,
  0xbf, 0x00, 0xfb, 0x00, 0xf3, 0x00, 0xe3, 0x00, 0x43, 0xe0, 0x00, 0xe0,
  0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0xe0, 0x00, 0xe0
};

uint8_t test1[] = {
    0x60,0x00,0x61,0x00,0x63,0x0F,0xF3,0x29,0xD0,0x15,0x12,0x0A
};

uint8_t test2[] = {
    0x60,0x00,0x61,0x00,0x63,0x0F,0xF3,0x29,0xD0,0x15,0xD0,0x15,0x12,0x0C
};

void parse_args(char* cmd) {
    char *p2;
    p2 = strtok(cmd, " ");

    while (p2 && argc < 7) {
        argv[argc++] = p2;
        p2 = strtok('\0', " ");
    }
    argv[argc] = '\0';
}

void main(void) {

    SEI();
    vdp_reset();
    vdp_colorize(VDP_BLACK);
    CLI();

    vdp_wait();
    vdp_flush(&FRAMEBUF);

    srand(1);
    chip = chip8_init();
    memcpy(&chip->ram[0x200], logo, sizeof(logo));
    printf("\n");
    /*
    * Process chip8 loop
    */
    chip->is_running = true;
    chip8_run(chip);

    chip8_destroy(chip);
    sfos_s_warmboot();
}

