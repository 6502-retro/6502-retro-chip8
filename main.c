/* vim: set et ts=4 sw=4: */
#include <6502.h>
#include <string.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdio.h>
#include "bios.h"
#include "vdp.h"
#include "chip8.h"

Chip8 *chip;
uint16_t i = 0;
uint16_t j = 0;
uint8_t argc = 0;
char *argv[8] = {0};
char *cmd = (char*)0x301;

uint8_t logo[] = {
  0x00, 0xe0, 0xa2, 0x2a, 0x60, 0x0c, 0x61, 0x08, 0xd0, 0x1f, 0x70, 0x09,
  0xa2, 0x39, 0xd0, 0x1f, 0xa2, 0x48, 0x70, 0x08, 0xd0, 0x1f, 0x70, 0x04,
  0xa2, 0x57, 0xd0, 0x1f, 0x70, 0x08, 0xa2, 0x66, 0xd0, 0x1f, 0x70, 0x08,
  0xa2, 0x75, 0xd0, 0x1f, 0x12, 0x28, 0xff, 0x00, 0xff, 0x00, 0x3c, 0x00,
  0x3c, 0x00, 0x3c, 0x00, 0x3c, 0x00, 0xff, 0x00, 0xff, 0xff, 0x00, 0xff,
  0x00, 0x38, 0x00, 0x3f, 0x00, 0x3f, 0x00, 0x38, 0x00, 0xff, 0x00, 0xff,
  0x80, 0x00, 0xe0, 0x00, 0xe0, 0x00, 0x80, 0x00, 0x80, 0x00, 0xe0, 0x00,
  0xe0, 0x00, 0x80, 0xf8, 0x00, 0xfc, 0x00, 0x3e, 0x00, 0x3f, 0x00, 0x3b,
  0x00, 0x39, 0x00, 0xf8, 0x00, 0xf8, 0x03, 0x00, 0x07, 0x00, 0x0f, 0x00,
  0xbf, 0x00, 0xfb, 0x00, 0xf3, 0x00, 0xe3, 0x00, 0x43, 0xe0, 0x00, 0xe0,
  0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0xe0, 0x00, 0xe0
};

uint8_t test1[] = {
    0x60,0x00,0x61,0x00,0x63,0x0F,0xF3,0x29,0xD0,0x15,0x12,0x0A
};

uint8_t test2[] = {
    0x60,0x00,0x61,0x00,0x63,0x0F,0xF3,0x29,0xD0,0x15,0xD0,0x15,0x12,0x0C
};
unsigned char corax_ch8[] = {
  0x12, 0x0a, 0x60, 0x01, 0x00, 0xee, 0x60, 0x02, 0x12, 0xa6, 0x00, 0xe0,
  0x68, 0x32, 0x6b, 0x1a, 0xa4, 0xf1, 0xd8, 0xb4, 0x68, 0x3a, 0xa4, 0xf5,
  0xd8, 0xb4, 0x68, 0x02, 0x69, 0x06, 0x6a, 0x0b, 0x6b, 0x01, 0x65, 0x2a,
  0x66, 0x2b, 0xa4, 0xb5, 0xd8, 0xb4, 0xa4, 0xed, 0xd9, 0xb4, 0xa4, 0xa5,
  0x36, 0x2b, 0xa4, 0xa1, 0xda, 0xb4, 0x6b, 0x06, 0xa4, 0xb9, 0xd8, 0xb4,
  0xa4, 0xed, 0xd9, 0xb4, 0xa4, 0xa1, 0x45, 0x2a, 0xa4, 0xa5, 0xda, 0xb4,
  0x6b, 0x0b, 0xa4, 0xbd, 0xd8, 0xb4, 0xa4, 0xed, 0xd9, 0xb4, 0xa4, 0xa1,
  0x55, 0x60, 0xa4, 0xa5, 0xda, 0xb4, 0x6b, 0x10, 0xa4, 0xc5, 0xd8, 0xb4,
  0xa4, 0xed, 0xd9, 0xb4, 0xa4, 0xa1, 0x76, 0xff, 0x46, 0x2a, 0xa4, 0xa5,
  0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xcd, 0xd8, 0xb4, 0xa4, 0xed, 0xd9, 0xb4,
  0xa4, 0xa1, 0x95, 0x60, 0xa4, 0xa5, 0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xad,
  0xd8, 0xb4, 0xa4, 0xed, 0xd9, 0xb4, 0xa4, 0xa5, 0x12, 0x90, 0xa4, 0xa1,
  0xda, 0xb4, 0x68, 0x12, 0x69, 0x16, 0x6a, 0x1b, 0x6b, 0x01, 0xa4, 0xb1,
  0xd8, 0xb4, 0xa4, 0xed, 0xd9, 0xb4, 0x60, 0x00, 0x22, 0x02, 0xa4, 0xa5,
  0x40, 0x00, 0xa4, 0xa1, 0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xa9, 0xd8, 0xb4,
  0xa4, 0xe1, 0xd9, 0xb4, 0xa4, 0xa5, 0x40, 0x02, 0xa4, 0xa1, 0x30, 0x00,
  0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xc9, 0xd8, 0xb4, 0xa4, 0xa9, 0xd9, 0xb4,
  0xa4, 0xa1, 0x65, 0x2a, 0x67, 0x00, 0x87, 0x50, 0x47, 0x2a, 0xa4, 0xa5,
  0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xc9, 0xd8, 0xb4, 0xa4, 0xad, 0xd9, 0xb4,
  0xa4, 0xa1, 0x66, 0x0b, 0x67, 0x2a, 0x87, 0x61, 0x47, 0x2b, 0xa4, 0xa5,
  0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xc9, 0xd8, 0xb4, 0xa4, 0xb1, 0xd9, 0xb4,
  0xa4, 0xa1, 0x66, 0x78, 0x67, 0x1f, 0x87, 0x62, 0x47, 0x18, 0xa4, 0xa5,
  0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xc9, 0xd8, 0xb4, 0xa4, 0xb5, 0xd9, 0xb4,
  0xa4, 0xa1, 0x66, 0x78, 0x67, 0x1f, 0x87, 0x63, 0x47, 0x67, 0xa4, 0xa5,
  0xda, 0xb4, 0x68, 0x22, 0x69, 0x26, 0x6a, 0x2b, 0x6b, 0x01, 0xa4, 0xc9,
  0xd8, 0xb4, 0xa4, 0xb9, 0xd9, 0xb4, 0xa4, 0xa1, 0x66, 0x8c, 0x67, 0x8c,
  0x87, 0x64, 0x47, 0x18, 0xa4, 0xa5, 0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xc9,
  0xd8, 0xb4, 0xa4, 0xbd, 0xd9, 0xb4, 0xa4, 0xa1, 0x66, 0x8c, 0x67, 0x78,
  0x87, 0x65, 0x47, 0xec, 0xa4, 0xa5, 0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xc9,
  0xd8, 0xb4, 0xa4, 0xc5, 0xd9, 0xb4, 0xa4, 0xa1, 0x66, 0x78, 0x67, 0x8c,
  0x87, 0x67, 0x47, 0xec, 0xa4, 0xa5, 0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xc9,
  0xd8, 0xb4, 0xa4, 0xc1, 0xd9, 0xb4, 0xa4, 0xa1, 0x66, 0x0f, 0x86, 0x66,
  0x46, 0x07, 0xa4, 0xa5, 0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xc9, 0xd8, 0xb4,
  0xa4, 0xe1, 0xd9, 0xb4, 0xa4, 0xa1, 0x66, 0xe0, 0x86, 0x6e, 0x46, 0xc0,
  0xa4, 0xa5, 0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xe5, 0xd8, 0xb4, 0xa4, 0xc1,
  0xd9, 0xb4, 0xa4, 0x9e, 0xf1, 0x65, 0xa4, 0xa5, 0x30, 0xaa, 0xa4, 0xa1,
  0x31, 0x55, 0xa4, 0xa1, 0xda, 0xb4, 0x68, 0x32, 0x69, 0x36, 0x6a, 0x3b,
  0x6b, 0x01, 0xa4, 0xe5, 0xd8, 0xb4, 0xa4, 0xbd, 0xd9, 0xb4, 0xa4, 0x9e,
  0x60, 0x00, 0x61, 0x30, 0xf1, 0x55, 0xa4, 0x9e, 0xf0, 0x65, 0x81, 0x00,
  0xa4, 0x9f, 0xf0, 0x65, 0xa4, 0xa5, 0x30, 0x30, 0xa4, 0xa1, 0x31, 0x00,
  0xa4, 0xa1, 0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xe5, 0xd8, 0xb4, 0xa4, 0xb5,
  0xd9, 0xb4, 0xa4, 0x9e, 0x66, 0x89, 0xf6, 0x33, 0xf2, 0x65, 0xa4, 0xa1,
  0x30, 0x01, 0x14, 0x32, 0x31, 0x03, 0x14, 0x32, 0x32, 0x07, 0x14, 0x32,
  0xa4, 0x9e, 0x66, 0x41, 0xf6, 0x33, 0xf2, 0x65, 0xa4, 0xa1, 0x30, 0x00,
  0x14, 0x32, 0x31, 0x06, 0x14, 0x32, 0x32, 0x05, 0x14, 0x32, 0xa4, 0x9e,
  0x66, 0x04, 0xf6, 0x33, 0xf2, 0x65, 0xa4, 0xa1, 0x30, 0x00, 0x14, 0x32,
  0x31, 0x00, 0x14, 0x32, 0x32, 0x04, 0x14, 0x32, 0xa4, 0xa5, 0xda, 0xb4,
  0x7b, 0x05, 0xa4, 0xe5, 0xd8, 0xb4, 0xa4, 0xe1, 0xd9, 0xb4, 0xa4, 0xa1,
  0x66, 0x04, 0xf6, 0x1e, 0xda, 0xb4, 0x7b, 0x05, 0xa4, 0xe9, 0xd8, 0xb4,
  0xa4, 0xed, 0xd9, 0xb4, 0xa4, 0xa5, 0x66, 0xff, 0x76, 0x0a, 0x36, 0x09,
  0xa4, 0xa1, 0x86, 0x66, 0x36, 0x04, 0xa4, 0xa1, 0x66, 0xff, 0x60, 0x0a,
  0x86, 0x04, 0x36, 0x09, 0xa4, 0xa1, 0x86, 0x66, 0x36, 0x04, 0xa4, 0xa1,
  0x66, 0xff, 0x86, 0x6e, 0x86, 0x66, 0x36, 0x7f, 0xa4, 0xa1, 0x86, 0x66,
  0x86, 0x6e, 0x36, 0x7e, 0xa4, 0xa1, 0x66, 0x05, 0x76, 0xf6, 0x36, 0xfb,
  0xa4, 0xa1, 0x66, 0x05, 0x86, 0x05, 0x36, 0xfb, 0xa4, 0xa1, 0x66, 0x05,
  0x80, 0x67, 0x30, 0xfb, 0xa4, 0xa1, 0xda, 0xb4, 0x14, 0x9c, 0xaa, 0x55,
  0x00, 0x00, 0xa0, 0x40, 0xa0, 0x00, 0xa0, 0xc0, 0x80, 0xe0, 0xa0, 0xa0,
  0xe0, 0xc0, 0x40, 0x40, 0xe0, 0xe0, 0x20, 0xc0, 0xe0, 0xe0, 0x60, 0x20,
  0xe0, 0xa0, 0xe0, 0x20, 0x20, 0xe0, 0xc0, 0x20, 0xc0, 0x60, 0x80, 0xe0,
  0xe0, 0xe0, 0x20, 0x40, 0x40, 0xe0, 0xe0, 0xa0, 0xe0, 0xe0, 0xe0, 0x20,
  0xc0, 0x40, 0xa0, 0xe0, 0xa0, 0xc0, 0xe0, 0xa0, 0xe0, 0xe0, 0x80, 0x80,
  0xe0, 0xc0, 0xa0, 0xa0, 0xc0, 0xe0, 0xc0, 0x80, 0xe0, 0xe0, 0x80, 0xc0,
  0x80, 0x00, 0xa0, 0xa0, 0x40, 0xa0, 0x40, 0xa0, 0xa0, 0x0a, 0xae, 0xa2,
  0x42, 0x38, 0x08, 0x30, 0xb8
};

unsigned char keypad_ch8[] = {
0x12,0x29,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x03,0x0C,0x04,0x05,0x06,0x0D,0x07,0x08,0x09,0x0E,0x0A,0x00,0x0B,0x0F,0x7E,0xFF,0xFF,0xFF,0xFF,0xFF,0x7E,0x61,0x12,0x62,0x01,0x63,0x00,0xA2,0x12,0xF3,0x1E,0xF0,0x65,0xF0,0x29,0xD1,0x25,0x71,0x08,0x41,0x32,0x72,0x08,0x41,0x32,0x61,0x12,0x73,0x01,0x33,0x10,0x12,0x2F,0x61,0x01,0x62,0x10,0x63,0x00,0xA2,0x02,0xF0,0x65,0x30,0x00,0x12,0x63,0xE1,0x9E,0x12,0x61,0x60,0x01,0xA2,0x22,0xD2,0x37,0x12,0x6D,0xE1,0xA1,0x12,0x6D,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x02,0xF0,0x55,0x61,0x02,0x62,0x18,0x63,0x00,0xA2,0x03,0xF0,0x65,0x30,0x00,0x12,0x8B,0xE1,0x9E,0x12,0x89,0x60,0x01,0xA2,0x22,0xD2,0x37,0x12,0x95,0xE1,0xA1,0x12,0x95,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x03,0xF0,0x55,0x61,0x03,0x62,0x20,0x63,0x00,0xA2,0x04,0xF0,0x65,0x30,0x00,0x12,0xB3,0xE1,0x9E,0x12,0xB1,0x60,0x01,0xA2,0x22,0xD2,0x37,0x12,0xBD,0xE1,0xA1,0x12,0xBD,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x04,0xF0,0x55,0x61,0x0C,0x62,0x28,0x63,0x00,0xA2,0x05,0xF0,0x65,0x30,0x00,0x12,0xDB,0xE1,0x9E,0x12,0xD9,0x60,0x01,0xA2,0x22,0xD2,0x37,0x12,0xE5,0xE1,0xA1,0x12,0xE5,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x05,0xF0,0x55,0x61,0x04,0x62,0x10,0x63,0x08,0xA2,0x06,0xF0,0x65,0x30,0x00,0x13,0x03,0xE1,0x9E,0x13,0x01,0x60,0x01,0xA2,0x22,0xD2,0x37,0x13,0x0D,0xE1,0xA1,0x13,0x0D,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x06,0xF0,0x55,0x61,0x05,0x62,0x18,0x63,0x08,0xA2,0x07,0xF0,0x65,0x30,0x00,0x13,0x2B,0xE1,0x9E,0x13,0x29,0x60,0x01,0xA2,0x22,0xD2,0x37,0x13,0x35,0xE1,0xA1,0x13,0x35,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x07,0xF0,0x55,0x61,0x06,0x62,0x20,0x63,0x08,0xA2,0x08,0xF0,0x65,0x30,0x00,0x13,0x53,0xE1,0x9E,0x13,0x51,0x60,0x01,0xA2,0x22,0xD2,0x37,0x13,0x5D,0xE1,0xA1,0x13,0x5D,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x08,0xF0,0x55,0x61,0x0D,0x62,0x28,0x63,0x08,0xA2,0x09,0xF0,0x65,0x30,0x00,0x13,0x7B,0xE1,0x9E,0x13,0x79,0x60,0x01,0xA2,0x22,0xD2,0x37,0x13,0x85,0xE1,0xA1,0x13,0x85,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x09,0xF0,0x55,0x61,0x07,0x62,0x10,0x63,0x10,0xA2,0x0A,0xF0,0x65,0x30,0x00,0x13,0xA3,0xE1,0x9E,0x13,0xA1,0x60,0x01,0xA2,0x22,0xD2,0x37,0x13,0xAD,0xE1,0xA1,0x13,0xAD,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x0A,0xF0,0x55,0x61,0x08,0x62,0x18,0x63,0x10,0xA2,0x0B,0xF0,0x65,0x30,0x00,0x13,0xCB,0xE1,0x9E,0x13,0xC9,0x60,0x01,0xA2,0x22,0xD2,0x37,0x13,0xD5,0xE1,0xA1,0x13,0xD5,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x0B,0xF0,0x55,0x61,0x09,0x62,0x20,0x63,0x10,0xA2,0x0C,0xF0,0x65,0x30,0x00,0x13,0xF3,0xE1,0x9E,0x13,0xF1,0x60,0x01,0xA2,0x22,0xD2,0x37,0x13,0xFD,0xE1,0xA1,0x13,0xFD,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x0C,0xF0,0x55,0x61,0x0E,0x62,0x28,0x63,0x10,0xA2,0x0D,0xF0,0x65,0x30,0x00,0x14,0x1B,0xE1,0x9E,0x14,0x19,0x60,0x01,0xA2,0x22,0xD2,0x37,0x14,0x25,0xE1,0xA1,0x14,0x25,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x0D,0xF0,0x55,0x61,0x0A,0x62,0x10,0x63,0x18,0xA2,0x0E,0xF0,0x65,0x30,0x00,0x14,0x43,0xE1,0x9E,0x14,0x41,0x60,0x01,0xA2,0x22,0xD2,0x37,0x14,0x4D,0xE1,0xA1,0x14,0x4D,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x0E,0xF0,0x55,0x61,0x00,0x62,0x18,0x63,0x18,0xA2,0x0F,0xF0,0x65,0x30,0x00,0x14,0x6B,0xE1,0x9E,0x14,0x69,0x60,0x01,0xA2,0x22,0xD2,0x37,0x14,0x75,0xE1,0xA1,0x14,0x75,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x0F,0xF0,0x55,0x61,0x0B,0x62,0x20,0x63,0x18,0xA2,0x10,0xF0,0x65,0x30,0x00,0x14,0x93,0xE1,0x9E,0x14,0x91,0x60,0x01,0xA2,0x22,0xD2,0x37,0x14,0x9D,0xE1,0xA1,0x14,0x9D,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x10,0xF0,0x55,0x61,0x0F,0x62,0x28,0x63,0x18,0xA2,0x11,0xF0,0x65,0x30,0x00,0x14,0xBB,0xE1,0x9E,0x14,0xB9,0x60,0x01,0xA2,0x22,0xD2,0x37,0x14,0xC5,0xE1,0xA1,0x14,0xC5,0x60,0x00,0xA2,0x22,0xD2,0x37,0xA2,0x11,0xF0,0x55,0x12,0x49
};

void parse_args(char* cmd) {
    char *p2;
    p2 = strtok(cmd, " ");

    while (p2 && argc < 7) {
        argv[argc++] = p2;
        p2 = strtok('\0', " ");
    }
    argv[argc] = '\0';
}

void main(void) {

    SEI();
    vdp_reset();
    vdp_colorize(VDP_BLACK);

    CLI();

    vdp_flush(&FRAMEBUF);

    srand(1);
    chip = chip8_init();
    memcpy(&chip->ram[0x200],keypad_ch8, sizeof(keypad_ch8));
    printf("\n");
    /*
    * Process chip8 loop
    */
    chip->is_running = true;
    chip8_run(chip);

    chip8_destroy(chip);
    prog_exit();
    bios_wboot();
}

